<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EasyBase – Digitális VIP / Kupon (Firebase, közös DB)</title>
<style>
  :root{ --bg:#0f1115; --card:#171a21; --muted:#a3acbe; --fg:#e8ecf1; --pri:#37d67a; --warn:#ffd166; --danger:#ef476f; --ok:#2ecc71; --accent:#00c2ff; --border:#232836; --link:#7dd3fc; }
  *{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial}
  body{margin:0;background:linear-gradient(180deg,#0e1117,#0b0d12);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 140deg,var(--pri),#1f9d5a 30%,#0b5c2e 60%,#0e141b 60%);box-shadow:0 0 0 2px #0b5c2e inset, 0 8px 24px rgba(0,0,0,.5)}
  .brand h1{font-size:18px;margin:0;letter-spacing:.3px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  nav button{background:#121621;border:1px solid var(--border);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  nav button.active{background:var(--card);border-color:#2a3145;box-shadow:0 0 0 2px #263047 inset}
  main{padding:18px 16px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:.2rem 0 1rem;font-size:18px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3145;background:#0f1420;color:var(--fg)}
  textarea{min-height:80px}
  .row{display:grid;gap:10px}
  @media(min-width:650px){.row{grid-template-columns:1fr 1fr}}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid #2a3145;background:#111622;color:var(--fg);cursor:pointer}
  .btn.primary{background:linear-gradient(0deg,#0f5,#0ad);border:0;color:#001b17;font-weight:700}
  .btn.warn{background:#201a04;border:1px solid #a68417}
  .btn.danger{background:#2a0f17;border:1px solid #7a2238}
  .btn.ghost{background:transparent;border-color:#2a3145}
  .muted{color:var(--muted)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px dashed #2a3145;text-align:left;font-size:14px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2a3145;background:#0f1420;font-size:12px}
  .pill.ok{border-color:#21533a;color:#9cf3c3;background:#0b1a12}
  .pill.bad{border-color:#6b2534;color:#ffb3c5;background:#1a0d12}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .right{margin-left:auto}
  .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0c111b;padding:2px 6px;border-radius:6px;border:1px solid #28334a}
  .center{text-align:center}
  .pass{max-width:420px;margin:0 auto;background:linear-gradient(180deg,#0e1320,#0b1019);border:1px solid #26324a;border-radius:22px;padding:18px;box-shadow:0 14px 40px rgba(0,0,0,.35)}
  .pass .head{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .pass .branddot{width:22px;height:22px;border-radius:8px;background:linear-gradient(140deg,#25d366,#00c2ff)}
  .pass .title{font-size:18px;margin:0}
  .pass .subtitle{margin:0;color:var(--muted);font-size:13px}
  .pass .big{font-size:28px;font-weight:800;letter-spacing:.6px}
  .hint{font-size:12px;color:var(--muted)}
  .hr{height:1px;background:#25314b;margin:12px 0}
  footer{padding:24px;color:#7b869c;text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>EasyBase – Digitális VIP / Kupon</h1>
    </div>
    <nav>
      <button id="tab-admin" class="active" onclick="switchTab('admin')">Admin</button>
      <button id="tab-redeem" onclick="switchTab('redeem')">Beváltás</button>
      <button id="tab-my" onclick="switchTab('my')">Kártyám</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <section id="view-admin" class="grid">
    <div class="card">
      <h2>Új kupon / VIP létrehozása</h2>
      <div class="row">
        <div>
          <label>Megnevezés</label>
          <input id="f_title" placeholder="Pl. VIP Belépő – Molnaszecsőd" />
        </div>
        <div>
          <label>Típus</label>
          <select id="f_type">
            <option value="VIP">VIP</option>
            <option value="FreeEntry">Ingyenes belépő</option>
            <option value="FreeRental">Ingyenes bérlés</option>
            <option value="Discount">Kedvezmény (%)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Kedvezmény mértéke (ha Discount)</label>
          <input id="f_discount" type="number" min="1" max="100" placeholder="Pl. 30" />
        </div>
        <div>
          <label>Lejárat</label>
          <input id="f_expires" type="date" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Felhasználások száma (összesen)</label>
          <input id="f_uses" type="number" min="1" value="1" />
        </div>
        <div>
          <label>Megjegyzés</label>
          <input id="f_note" placeholder="Pl. Sorsolás nyertes – Aug 16." />
        </div>
      </div>
      <div class="flex">
        <button class="btn primary" onclick="createVoucher()">Létrehozás</button>
        <span class="hint">Mentés: Firestore (közös adatbázis).</span>
      </div>
    </div>

    <div class="card">
      <h2>Kuponok / VIP kártyák</h2>
      <table class="table" id="tbl"></table>
    </div>
  </section>

  <section id="view-redeem" class="grid" style="display:none">
    <div class="card">
      <h2>Beváltás – kód megadása</h2>
      <label>Kód</label>
      <input id="redeem_code" placeholder="Pl. EB-9XM4-7QPA-2025" />
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" onclick="checkCode(false)">Ellenőrzés</button>
        <button class="btn" onclick="checkCode(true)">Ellenőrzés + Beváltás</button>
        <span id="redeem_msg" class="hint"></span>
      </div>
    </div>

    <div class="card">
      <h2>Beváltási előzmények</h2>
      <div id="redeem_log" class="muted" style="white-space:pre-wrap"></div>
    </div>
  </section>

  <section id="view-my" style="display:none">
    <div class="card">
      <h2>Kártyám megnyitása</h2>
      <label>Illeszd be a kapott kódot vagy nyisd meg kóddal a linket ( ?code=... )</label>
      <input id="my_code" placeholder="Pl. EB-9XM4-7QPA-2025" />
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" onclick="showPass()">Megjelenítés</button>
        <button class="btn" onclick="downloadPass('png')">Letöltés PNG</button>
        <button class="btn" onclick="downloadPass('jpg')">Letöltés JPG</button>
        <span class="hint">A kép elküldhető Messengeren – nyomtatás nem szükséges.</span>
      </div>
    </div>

    <div class="pass" id="pass" style="display:none">
      <div class="head">
        <div class="branddot"></div>
        <div>
          <p class="title" id="p_title">EasyBase VIP</p>
          <p class="subtitle">www.easybaseairsoft.hu</p>
        </div>
        <span class="pill right" id="p_status">Érvényes</span>
      </div>
      <div class="big" id="p_type">VIP</div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <div class="muted">Sorszám</div>
          <div class="code" id="p_code">EB-XXXX-XXXX-2025</div>
        </div>
        <div>
          <div class="muted">Lejár</div>
          <div id="p_expires">—</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <div class="muted">Megjegyzés</div>
          <div id="p_note">—</div>
          <div class="hr"></div>
          <div class="muted">Felhasználások</div>
          <div id="p_uses">—</div>
          <div class="hr"></div>
          <div class="muted">Állapot</div>
          <div id="p_state">—</div>
        </div>
      </div>
    </div>
    <div class="center hint" style="margin-top:10px">A kupon/VIP adatai az admin oldalon kezelhetők. Beváltáskor az állapot frissül.</div>
  </section>
</main>

<footer>EasyBaseAirsoft – Firestore-os, egy fájlos kuponrendszer.</footer>

<!-- Firebase + App logika (ESM, nincs npm) -->
<script type="module">
  // Firebase SDK-k (12.1.0)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import {
    getFirestore, collection, doc, addDoc, getDocs, onSnapshot,
    updateDoc, deleteDoc, serverTimestamp, query, orderBy, increment
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // SAJÁT KONFIGOD
  const firebaseConfig = {
    apiKey: "AIzaSyAgN0ap-hbie5d-3IeNxG4Zmboe4Z4TvOI",
    authDomain: "easybasevip.firebaseapp.com",
    projectId: "easybasevip",
    storageBucket: "easybasevip.firebasestorage.app",
    messagingSenderId: "678338459460",
    appId: "1:678338459460:web:6d4f088ed5ac2bef324911",
    measurementId: "G-QWRPCJ118T"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const fs = getFirestore(app);

  // segédek
  const $ = id => document.getElementById(id);
  const text = (id,val)=>{ $(id).textContent = val }
  const escapeHtml = s=>String(s??'').replace(/[&<>"']/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]));
  const escapeAttr = s=>String(s||'').replace(/["'`\\\n\r\t\f\v]/g,'');
  function uid(len=4){ const abc='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=abc[Math.floor(Math.random()*abc.length)]; return s }
  const makeCode=()=>`EB-${uid(4)}-${uid(4)}-${new Date().getFullYear()}`;

  // állapot + Firestore ref
  let db = [];
  const colV = collection(fs,'vouchers');
  const colLog = collection(fs,'logs');

  // render
  function statusPill(v){
    const exOk = !v.expires || (new Date(v.expires) >= new Date(new Date().toDateString()));
    const left = (v.uses||0)-(v.used||0);
    const ok = !!v.active && exOk && left>0;
    const cls = ok? 'pill ok':'pill bad';
    const txt = ok? 'Érvényes' : (!exOk? 'Lejárt' : left<=0? 'Elfogyott' : 'Felfüggesztve');
    return `<span class="${cls}">${txt}</span>`;
  }
  function renderTable(){
    const el = $('tbl');
    if(!db.length){ el.innerHTML = '<tr><td class="muted">Még nincs kupon. Hozz létre egyet bal oldalt.</td></tr>'; return }
    el.innerHTML = `
      <tr>
        <th>Sorszám</th><th>Cím</th><th>Típus</th><th>Lejár</th><th>Felhasz.</th><th>Állapot</th><th></th>
      </tr>
      ${db.map(v=>`
        <tr>
          <td><span class="code">${escapeHtml(v.code)}</span></td>
          <td>${escapeHtml(v.title||'—')}</td>
          <td>${v.type}${v.type==='Discount'&&v.discount?` (${v.discount}%)`:''}</td>
          <td>${v.expires||'—'}</td>
          <td>${(v.used||0)}/${(v.uses||0)}</td>
          <td>${statusPill(v)}</td>
          <td>
            <div class="flex">
              <button class="btn" onclick="copy('${escapeAttr(v.code)}')">Kód másolása</button>
              <button class="btn" onclick="openMy('${escapeAttr(v.code)}')">Kártya</button>
              <button class="btn warn" onclick="toggleActive('${escapeAttr(v.id)}')">${v.active?'Felfüggeszt':'Aktivál'}</button>
              <button class="btn danger" onclick="delVoucher('${escapeAttr(v.id)}')">Törlés</button>
            </div>
          </td>
        </tr>
      `).join('')}
    `;
  }
  async function renderLog(){
    const q = query(colLog, orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    const lines=[]; snap.forEach(d=>{const x=d.data(); lines.push(`[${x.createdAt?.toDate?.().toISOString?.()||'—'}] ${x.msg||''}`)});
    $('redeem_log').textContent = lines.join('\n').trim() || '–';
  }

  // CRUD
  async function createVoucher(){
    const v = {
      code: makeCode(),
      title: $('f_title').value.trim() || 'EasyBase VIP / Kupon',
      type:  $('f_type').value,
      discount: parseInt($('f_discount').value||'0',10)||0,
      expires: $('f_expires').value || '',
      uses: parseInt($('f_uses').value||'1',10),
      used: 0,
      note: $('f_note').value.trim(),
      createdAt: serverTimestamp(),
      active: true
    };
    await addDoc(colV, v);
    alert(`Létrehozva: ${v.code}`);
  }
  async function toggleActive(id){ const v=db.find(x=>x.id===id); if(!v) return; await updateDoc(doc(fs,'vouchers',id),{active:!v.active}); }
  async function delVoucher(id){ if(!confirm('Biztos törlöd?')) return; await deleteDoc(doc(fs,'vouchers',id)); }
  async function log(msg){ await addDoc(colLog,{msg,createdAt:serverTimestamp()}); renderLog(); }

  // beváltás/kártya/letöltés
  function findByCode(code){ code=(code||'').trim().toUpperCase(); return db.find(v=>(v.code||'').toUpperCase()===code) }
  async function checkCode(andRedeem){
    const code = $('redeem_code').value.trim();
    const out = $('redeem_msg');
    const v = findByCode(code);
    if(!v){ out.textContent='Nincs ilyen kód.'; out.style.color='var(--danger)'; return }
    const exOk = !v.expires || (new Date(v.expires) >= new Date(new Date().toDateString()));
    const left = (v.uses||0)-(v.used||0);
    const ok = !!v.active && exOk && left>0;
    out.textContent = `Állapot: ${ok?'ÉRVÉNYES':'NEM érvényes'} | Felhasználások: ${(v.used||0)}/${(v.uses||0)}`;
    out.style.color = ok? 'var(--ok)' : 'var(--danger)';
    if(ok && andRedeem){
      await updateDoc(doc(fs,'vouchers',v.id),{used: increment(1)});
      await log(`Beváltva: ${v.code} – ${v.title}`);
      out.textContent = `Beváltva. Új állapot: ${(v.used||0)+1}/${(v.uses||0)}`;
    }
  }
  function openMy(code){ switchTab('my'); $('my_code').value=code; setTimeout(showPass,0); }
  function showPass(){
    const code = ($('my_code').value||'').trim();
    const v = findByCode(code);
    const pass = $('pass');
    if(!v){ alert('Ismeretlen kód. Kérj újat az adminisztrátortól.'); return }
    pass.style.display='block';
    text('p_title', v.title||'EasyBase VIP / Kupon');
    text('p_type', v.type + (v.type==='Discount' && v.discount? ` – ${v.discount}%` : ''));
    text('p_code', v.code);
    text('p_expires', v.expires || '—');
    text('p_note', v.note || '—');
    text('p_uses', `${v.used||0}/${v.uses||0}`);
    const exOk = !v.expires || (new Date(v.expires) >= new Date(new Date().toDateString()));
    const left = (v.uses||0) - (v.used||0); const ok = !!v.active && exOk && left>0;
    const state = ok? 'Érvényes' : (!exOk? 'Lejárt' : left<=0? 'Elfogyott' : 'Felfüggesztve');
    text('p_state', state); const ps=$('p_status'); ps.textContent=state; ps.className='pill right ' + (ok?'ok':'bad');
    const url = new URL(window.location.href); url.searchParams.set('code', v.code); history.replaceState(null,'',url);
  }
  async function copy(text){ try{ await navigator.clipboard.writeText(text); alert('Kimásolva'); }catch(e){ prompt('Másold ki:', text) } }

  function downloadPass(fmt){
    const node = $('pass'); if(node.style.display==='none'){ alert('Előbb jelenítsd meg a kártyát.'); return }
    const code = $('p_code').textContent;
    const scale=2, W=860, H=560; const c=document.createElement('canvas'); c.width=W*scale; c.height=H*scale; const ctx=c.getContext('2d');
    ctx.scale(scale,scale);
    const grd=ctx.createLinearGradient(0,0,0,H); grd.addColorStop(0,'#0e1320'); grd.addColorStop(1,'#0b1019'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#2a3a5a'; ctx.lineWidth=3; roundRect(ctx,16,16,W-32,H-32,24); ctx.stroke();
    ctx.globalAlpha=0.35; ctx.fillStyle='#00c2ff'; roundRect(ctx,20,20,W-40,H-40,22); ctx.stroke(); ctx.globalAlpha=1;
    ctx.fillStyle='#e8ecf1'; ctx.font='bold 28px system-ui'; ctx.fillText($('p_title').textContent,32,56);
    ctx.font='14px system-ui'; ctx.fillStyle='#a3acbe'; ctx.fillText('www.easybaseairsoft.hu',32,78);
    const state=$('p_state').textContent; badge(ctx, W-170, 30, state, state==='Érvényes');
    ctx.font='800 42px system-ui'; ctx.fillText($('p_type').textContent,32,128);
    line(ctx,32,142,W-32,142);
    ctx.font='14px system-ui'; ctx.fillStyle='#a3acbe'; ctx.fillText('Sorszám',32,172);
    ctx.font='16px ui-monospace'; ctx.fillStyle='#e8ecf1'; ctx.fillText(code,32,194);
    ctx.font='14px system-ui'; ctx.fillStyle='#a3acbe'; ctx.fillText('Lejár',32,222);
    ctx.font='16px system-ui'; ctx.fillStyle='#e8ecf1'; ctx.fillText($('p_expires').textContent,32,244);
    roundRect(ctx,32,272,300,240,16); ctx.strokeStyle='#2c3852'; ctx.lineWidth=2; ctx.stroke();
    ctx.font='bold 26px ui-monospace'; ctx.fillText(code,40,330);
    ctx.font='14px system-ui'; ctx.fillStyle='#a3acbe'; ctx.fillText('Megjegyzés',372,198);
    ctx.font='16px system-ui'; ctx.fillStyle='#e8ecf1'; wrapText(ctx, $('p_note').textContent,372,220, W-372-32, 22);
    line(ctx,372,248,W-32,248);
    ctx.fillStyle='#a3acbe'; ctx.fillText('Felhasználások',372,278);
    ctx.fillStyle='#e8ecf1'; ctx.fillText($('p_uses').textContent,372,300);
    line(ctx,372,326,W-32,326);
    ctx.fillStyle='#a3acbe'; ctx.fillText('Állapot',372,356);
    ctx.fillStyle='#e8ecf1'; ctx.fillText(state,372,378);
    const a=document.createElement('a'); const mime=(fmt==='jpg'||fmt==='jpeg')?'image/jpeg':'image/png';
    a.href=c.toDataURL(mime,0.92); a.download=`${code}.${fmt==='jpg'?'jpg':'png'}`; a.click();
  }
  function line(ctx,x1,y1,x2,y2){ ctx.strokeStyle='#25314b'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
  function badge(ctx,x,y,text,isOk){ const w=120,h=28,r=12; ctx.fillStyle=isOk?'#0b1a12':'#1a0d12'; ctx.strokeStyle=isOk?'#21533a':'#6b2534'; ctx.lineWidth=1.5; roundRect(ctx,x,y,w,h,r); ctx.stroke(); ctx.fillStyle=isOk?'#9cf3c3':'#ffb3c5'; ctx.font='bold 14px system-ui'; ctx.fillText(text,x+14,y+19); }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function wrapText(ctx,t,x,y,maxW,lh){ const words=(t||'').split(' '); let line=''; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; const {width}=ctx.measureText(test); if(width>maxW && n>0){ ctx.fillText(line,x,y); line=words[n]+' '; y+=lh; } else line=test; } ctx.fillText(line,x,y); }

  // fülek
  function switchTab(name){
    for(const id of ['admin','redeem','my']){
      document.getElementById('view-'+id).style.display = (id===name)? '' : 'none';
      document.getElementById('tab-'+id).classList.toggle('active', id===name);
    }
  }

  // realtime sync
  function startRealtime(){
    onSnapshot(colV, (snap)=>{
      db = snap.docs.map(d=>({id:d.id, ...d.data()}))
                    .sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
      renderTable();
    });
    renderLog();
  }

  // indulás
  function boot(){
    startRealtime();
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    if(code){ switchTab('my'); $('my_code').value=code; setTimeout(showPass,0); }
  }
  boot();

  // onclick-ekhez
  Object.assign(window,{switchTab,createVoucher,delVoucher,toggleActive,copy,openMy,checkCode,showPass,downloadPass});
</script>
</body>
</html>
